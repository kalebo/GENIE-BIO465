---
title: "PipelineDevelopment"
author: "Kaleb Olson"
date: "April 13, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(reshape2)
library(magrittr)
library(readr)
library(synapseClient)
library(doParallel)
synapseLogin()
```

Load all the data we want to work with.
```{r}
genie.filtered.cn <- readRDS("genie-filtered-cn.rds")
gdsc.filtered.cn <- readRDS("gdsc-filtered-cn.rds")
gdsc.filtered.cn.t <- readRDS("gdsc-filtered-cn-t.rds") 

celline.to.cosmicid <- readRDS("gdsc-cellline-to-cosmic-id.rds")
screeened.compounds <- readRDS("screened-compounds.rds")
dose.response <- readRDS("dose-response.rds")

genie.clin <- readRDS("genie-clin.rds")
intersecting.genes <- readRDS("intersecting-genes.rds")
genie.filtered.cnclin <- readRDS("genie-filtered-cn-clin.rds")
```

Make a tree map breakdown of cancer and cancer sub-type.
```{r}
#test.count <- genie.clin %>% group_by(CANCER_TYPE_DETAILED) %>% mutate(COUNT = n())
#png(filename="tree.png",width=1024, height=600);
#treemap(test.count, index=c("CANCER_TYPE", "CANCER_TYPE_DETAILED"), vSize = "COUNT", type="index", palette= "Reds", align.labels = list(c("center", "center"), c("right", "bottom")), title="GENIE - Breakdown by cancer and cancer sub-type", fontsize.labels=c(18,10), fontsize.title = 18);
#dev.off()
```

Example of how genie.filtered.cnclin is generated:
```
syn.clin <- synGet('syn7851246')
genie.clin <- read_tsv(syn.clin@filePath)
genie.filtered.cn.cst <- melt(genie.filtered.cn) %>% dcast(variable ~ ...)
colnames(genie.filtered.cn.cst)[1] <- "SAMPLE_ID"
genie.filtered.cnclin <- inner_join(genie.clin, genie.filtered.cn.cst)
saveRDS(genie.filtered.cnclin, "genie-filtered-cn-clin.rds")
```

Here is how the transposed and trimmed version of gdsc.filtered.cn was generated
```{r}
gdsc.filtered.cn.t <- as.data.frame(t(gdsc.filtered.cn))[c(-2, -3, -4),]

```

```{r}
translate <- function(quaddle) {
  maxchar <- substr(quaddle, 1, 1)
  max <- as.numeric(maxchar)
  if (!is.na(max) && max >= 9) {
    2
  }
  else if (!is.na(max) && max < 9) {
    switch(maxchar,
           "0" = -2,
           "1" = -1,
           "2" = 0,
           "3" = 1,
           "4" = 2,
           "5" = 2,
           "6" = 2,
           "7" = 2,
           "8" = 2)
  }
  else{
    NA
  }
}

gdsc.filtered.cn.trans <- apply(gdsc.filtered.cn.t, c(1,2), translate)
```

Here we check the gene EFGR (row number 138 in each dataset because we ordered genes alphabetically) to check that we get a comparable distribution of cnv values. This depends on an accurate translation of cnv data from gdsc style to genie style. The EFGR gene can be considered as a baseline because ...
```{r}
gdsc.efgr <- table(sapply( gdsc.filtered.cn[138, 5:ncol(gdsc.filtered.cn)],  translate))
genie.efgr <- table(unlist(genie.filtered.cn[138, 2:ncol(genie.filtered.cn) ]))
sapply(gdsc.efgr, function(x) x/ncol(gdsc.filtered.cn))
sapply(genie.efgr, function(x) x/ncol(genie.filtered.cn))

```
ERBB2
```{r}
gdsc.efgr <- table(sapply( gdsc.filtered.cn[150, 5:ncol(gdsc.filtered.cn)],  translate))
genie.efgr <- table(unlist(genie.filtered.cn[150, 2:ncol(genie.filtered.cn) ]))
sapply(gdsc.efgr, function(x) x/ncol(gdsc.filtered.cn))
sapply(genie.efgr, function(x) x/ncol(genie.filtered.cn))

```

Question: how many times does max not equal min in the unconverted GDSC data?
```{r}
maxeqmin <- function(x) {
  max_r <- substr(x, 1,1)
  min_r <- substr(x, 3,3)
  max_r == min_r
}


tout <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t),], c(1,2), maxeqmin)
table(tout)

```
Question: how many times do we find that if the two don't match that the max is greater than 8
```{r}
maxneandgt8 <- function(x) {
  quad <- unlist(strsplit(x, ","))
  max_r <- quad[1]
  min_r <- quad[2]
  max_i = as.numeric(max_r)
  
  if (max_i != min_r){
     max_i >= 4
  }
  else {
    FALSE
  }
}
mout <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t), ], c(1,2), maxneandgt8)
table(mout)
```

```{r}
bettertrans <- function(x){ 
  quad <- unlist(strsplit(x, ","))
  max_i <- as.numeric(quad[1])
  min_i <- as.numeric(quad[2])
  
  if (max_i == 0){
    -2
  }
  else if (max_i == 1) {
    -1
  }
  else if (max_i <= 3) {
    0
  }
  else if (max_i <= 8 && min_i < 8 ) {
    1
  }
  else {
    2
  }
}

gdsc.filtered.cn.bettertrans <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t), ], c(1,2), bettertrans)
gdsc.cn.table <- as.data.frame(table(gdsc.filtered.cn.bettertrans))
colnames(gdsc.cn.table) <- c("cn", "freq")
```

```{r}
wipenonextr <- function(x){
  if (x != -2 || x != 2) {
    0
  }
  else {
    x
  }
}

sum(genie.filtered.cn[,2:ncol(genie.filtered.cn)] == -2) +
sum(genie.filtered.cn[,2:ncol(genie.filtered.cn)] == 2)
```

Make a plot of the distribution:
```{r}
genie.cn.table <- as.data.frame(table(unlist(genie.filtered.cn[,2:ncol(genie.filtered.cn)])))
colnames(genie.cn.table) <- c("cn", "freq")
```

```{r}
library(scales)
ggplot(genie.cn.table[-2,]) + geom_col(aes(x = cn, y = freq), fill="#B22222") + scale_y_log10( breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) + labs(x="Discrete CN Level", y ="Count", title="GENIE Copy Number Distribution")

ggplot(gdsc.cn.table) + geom_col(aes(x = cn, y = freq), fill="#B22222") + scale_y_log10( breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) + labs(x="Discrete CN Level", y ="Count", title="Translated GDSC Copy Number Distribution")
```


Now we choose a drug that is has at least one record that is very low IC50. In this case #104. We filter for this drug and any record that is less than our threshold of -2 for IC50
```{r}
gdsc.filtered.cn.bettertrans.df <- as.data.frame(gdsc.filtered.cn.bettertrans).
colnames(gdsc.filtered.cn.bettertrans.df) <- unlist(intersecting.genes)

library(data.table)
gdsc.filtered.cn.bettertrans.df <- setDT(gdsc.filtered.cn.bettertrans.df, keep.rownames = TRUE)[]
colnames(gdsc.filtered.cn.bettertrans.df)[1] <- "COSMIC_ID"

```

Now we show a trivial example of how we are going to compare profile sets. Note- that we will need to consider the positive 2 and the negative 2 cases individually.
```{r}
drug_id = 104
drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < -2)
profilein.2 <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)

drug_id = 201
drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < -2)
profilein.1 <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)

profile.104 <- apply(unlist(profilein.2 == 2), 2, function(x) sum(x)/length(x))
profile.201 <-  apply(unlist(profilein.1 == 2), 2, function(x) sum(x)/length(x))
dist(rbind(profile.201, profile.104), method = "euclidian")
```

We generalize the above as functions:
```{r}
colProp <- function(col) {sum(col)/length(col)}
mkProfile <- function(set, cnlevel) {apply(unlist(set == cnlevel), 2, colProp)}
subsetDist <- function(set_a, set_b, cnlevel) {
  profileDist <- function(p1, p2) {dist(rbind(p1, p2), method = "euclidian")}
  profileDist(mkProfile(set_a, cnlevel), mkProfile(set_b, cnlevel))
}

compareDrugs <- function(drug_id1, drug_id2, threshold, cnlevel) {
  mkRecordSet <- function(drug_id, threshold) {
    drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < threshold)
    records <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)
    #assertthat::assert_that(length(records) >= 100)
    records
  }
  
  subsetDist(mkRecordSet(drug_id1, threshold), mkRecordSet(drug_id2, threshold), cnlevel)
}

```

This is where we rank the Strongest Drugs by LN and AUC
```{r}
#Drugs with most cell line responders.
strongestDrugs <- dose.response %>% filter(LN_IC50 < -2, AUC > .5) %>% group_by(DRUG_ID) %>% summarise(drugPower = sum(LN_IC50 < -2)) %>% arrange(desc(drugPower))

# How many entries are eliminated by filtering AUC
LN_Filtered_Count <- dose.response %>% filter(LN_IC50 < -2) %>% nrow()
LN_AUC_filtered_Count <- dose.response %>% filter(LN_IC50 < -2, AUC > .5) %>% nrow()
AUC_Count <- LN_Count - AUC_filtered
AUC_Count
#filter(strongestDrugs, stronge)
```


```{r}
# Create GDSC Drug Id CNLevel Profile Table, Parameters = cnLevels v(), drugIds v(), IC_50 threshold
makeDrugCNProfileTable <- function(cnlevels, drugIDs, threshold){
  headerLine <- c("DRUG_ID", "CN_LEVEL", unlist(intersecting.genes))
  gdsc.drug.cn.profile <- data.frame(matrix(ncol = length(headerLine), nrow = 0))
  for(drugID in drugIDs)
  {
    for(copyLevel in cnlevels)
    {
    drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < threshold)
    records <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)
    profile <- mkProfile(records, copyLevel)
    gdsc.drug.cn.profile <- rbind(gdsc.drug.cn.profile, c(drugID, copyLevel, unlist(profile)[-1]))
    }
  }
  colnames(gdsc.drug.cn.profile) <- headerLine
  return (gdsc.drug.cn.profile)
}

```

Subtyping GENIE     (I think this is the older version)
```{r}
#transpose the genie filtered CN df
genie.filtered.cn.t <- t(genie.filtered.cn)
#Strip first row 
genie.filtered.cn.t<- as.data.frame(genie.filtered.cn.t[-1,])
# Rename Columns to be the matching genes which we know is in the same order
colnames(genie.filtered.cn.t) <- unlist(intersecting.genes)
#Make the rownames into values
genie.filtered.cn.t <- setDT(genie.filtered.cn.t,keep.rownames = TRUE)[]
# make the first column header to be SAMPLE_ID
colnames(genie.filtered.cn.t)[1] <- "SAMPLE_ID"
# Now its all READY!!!

# check makeup of the Cancer types
genie.cancer.types <- as.data.frame(summary(factor(genie.clin$CANCER_TYPE)))
genie.Ages <- as.data.frame(summary(factor(genie.clin$AGE_AT_SEQ_REPORT)))
#Use filter to manually create subtypes
filter(genie.clin,PRIMARY_RACE == "White")

filterString <- 'ETHNICITY == "Non-Spanish/non-Hispanic",PRIMARY_RACE == "White", SEX == "Male", CANCER_TYPE == "Non-Small Cell Lung Cancer"'


filterString1 <- paste('filter(genie.clin,',filterString,")")
  
  
#Example of highly specific subset
example_subset <-filter(genie.clin,eval(as.name(filterString)))
#Variables for subsets will follow this template:
#genie.CANCER_TYPE.CANCER_TYPE_DETAILED.SEX.ETHNICITY.PRIMARY_RACE.AGE_AT_SEQ_REPORT

test <- eval(parse(text=filterString1))
pat <- test$PATIENT_ID

```


Function to generate the genie subsets as well as generate the CN Profiles
```{r}
makeGenieSubsetProfile <- function(filterString, cnlevel){
  # create entire filter command in one string
  filterString1 <- paste('filter(genie.clin,',filterString,")")  
  # run the filter command
  subsetClinical <- eval(parse(text=filterString1))
  records <- filter(genie.filtered.cn.t, SAMPLE_ID %in% subsetClinical$SAMPLE_ID)
  #only subsets with more than 100 samples are valid
  assertthat::assert_that(length(records) >= 100)
  #generate profile and return it
  mkProfile(records, cnlevel)
}

```


```{r}

  mkRecordSet <- function(drug_id, threshold) {
    drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < threshold)
    records <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)
    assertthat::assert_that(length(records) >= 100)
    records
  }

```

Where we checked to see if CDKN2B occurred most frequently as max gene.
```{r}
ids <- arrange(dose.response, LN_IC50)$DRUG_ID
trt<- function(id) {which.max((mkProfile(mkRecordSet(id, 2), -2)))}
sapply(unlist(ids[1:15]), trt)
```



------------------Subtyping GENIE ----------------------
```{r}
#transpose the genie filtered CN df
genie.filtered.cn.t <- t(genie.filtered.cn)
#Strip first row 
genie.filtered.cn.t<- as.data.frame(genie.filtered.cn.t[-1,])
# Rename Columns to be the matching genes which we know is in the same order
colnames(genie.filtered.cn.t) <- unlist(intersecting.genes)
#Make the rownames into values
genie.filtered.cn.t <- setDT(genie.filtered.cn.t,keep.rownames = TRUE)[]
# make the first column header to be SAMPLE_ID
colnames(genie.filtered.cn.t)[1] <- "SAMPLE_ID"
# Now its all READY!!!

# check makeup of the Cancer types
genie.cancer.types <- as.data.frame(summary(factor(genie.clin$CANCER_TYPE)))
genie.Ages <- as.data.frame(summary(factor(genie.clin$AGE_AT_SEQ_REPORT)))
#Use filter to manually create subtypes
filter(genie.clin,PRIMARY_RACE == "White")

filterString <- 'ETHNICITY == "Non-Spanish/non-Hispanic",PRIMARY_RACE == "White", SEX == "Male", CANCER_TYPE == "Non-Small Cell Lung Cancer"'


filterString1 <- paste('filter(genie.clin,',filterString,")")
  
  
#Example of highly specific subset
example_subset <-filter(genie.clin,eval(as.name(filterString)))
#Variables for subsets will follow this template:
#genie.CANCER_TYPE.CANCER_TYPE_DETAILED.SEX.ETHNICITY.PRIMARY_RACE.AGE_AT_SEQ_REPORT

test <- eval(parse(text=filterString1))
pat <- test$PATIENT_ID

```


Function to generate the genie subsets as well as generate the CN Profiles
```{r}
numValidFilters<-0
i<-0

makeGenieSubsetProfile <- function(filterString, cnlevel){
  
  # create entire filter command in one string
  filterString1 <- paste('filter(genie.clin,',filterString,")")  
  # run the filter command
  subsetClinical <- eval(parse(text=filterString1))
  records <- filter(genie.filtered.cn.t, SAMPLE_ID %in% subsetClinical$SAMPLE_ID)
  #print(records)
  #only subsets with more than 100 samples are valid
  #print("Grabbed Records")
  #print(nrow(records))
  if (nrow(records) < 100){
    return(NA)
  }
 # assertthat::assert_that(nrow(records) >= 100){return NULL}
  print("We have more than 100 records")
  numValidFilters<-numValidFilters+1
  i<-i+1
  #print(numValidFilters)
  #print(i)
  #generate profile and return it
  mkProfile(records, cnlevel)
}


```

Generate DataFrame of FilterStrings and their ID
```{r}
genie.cancer.types <- setDT(genie.cancer.types,keep.rownames = TRUE)[]
colnames(genie.cancer.types)[2] <- "Count"

cancer_types <- filter(genie.cancer.types, Count > 500) %>% arrange(desc(Count))
cancer_types <- c(cancer_types[,1])

#cancer type detailed vector
colnames(top10detailed)[2] <- "Count"
colnames(top10detailed)[1] <- "CANCER_TYPE_DETAILED"
detailed_cancer <- arrange(top10detailed, desc(Count))
cancer_types_detailed <- detailed_cancer$CANCER_TYPE_DETAILED
cancer_types_detailed <- cancer_types_detailed[1:15]

#Sex vector
sexes<- c("Male","Female")

#races vector
races <- c("White", "Black", "Asian")

```

```{r}

filterStrings <- data.frame(ID= c(1:10000),
                 FilterString = c(""))
generateFilters <- function(cancers=NA, cancer_subtypes=NA, sexes=NA, races=NA, ages= NA){
  results <- c()
  #sapply(cancers,singleFilterSet)
  results <- append(results,as.character(sapply(cancers,singleFilterSet)))
  
  if (!is.na(cancers)){
    for (cancer in cancers){
      for (sex in sexes){
        results <- append(results,singleFilterSet(cancer,sex=sex))
      }
    }
  }
  
  if (!is.na(races)){
    for (cancer in cancers){
      for (race in races){
        results <- append(results,singleFilterSet(cancer,race = race))
      }
    }
  }
  
  if (!is.na(cancer_subtypes)){
    for (cancer in cancers){
      for (cancer_subtype in cancer_subtypes){
        results <- append(results,singleFilterSet(cancer,cancer_subtype = cancer_subtype))
      }
    }
  }
  
  if (!is.na(ages)){
    for (cancer in cancers){
      for (age in ages){
        results <- append(results,singleFilterSet(cancer,age = age))
      }
    }
  }
  results
  
}

```

Generate and Clean up results from generateFilters function
```{r}
filterStrings <- as.data.frame(generateFilters(cancer_types,sexes = sexes,races = races))
filterStrings <- setDT(filterStrings,keep.rownames = TRUE)[]
colnames(filterStrings)[1] <- "ID"
colnames(filterStrings)[2] <- "FilterString"

filterStrings[] <- lapply(filterStrings[],as.character)
```


Make Profiles from the generated Filter Strings
```{r}
genieProfiles <-data.frame()
for (filter in filterStrings$FilterString){
  genieProfile<-makeGenieSubsetProfile(filter,2)
  #make row
  newRow <- append(genieRow,filterStrings$ID,after==0)
  newRow <-as.data.frame(genieProfile)
  newRow <- t(newRow)
  newRow<-as.data.frame(newRow)
  genieProfiles <- bind_rows(genieProfiles,newRow)
  
  #print(i)
}
  genieRow <- makeGenieSubsetProfile(filterStrings[4,2],2) 
  newRow <- append(genieRow,4,after=0)
  newRow <- append(newRow,2,after=1)
  newRow <- as.data.frame(newRow)
  newRow <- t(newRow)
  newRow<-as.data.frame(newRow)
  genieProfiles <- bind_rows(genieProfiles,newRow)

```



```{r}
singleFilterSet <- function(cancer=NA, cancer_subtype=NA, sex=NA, race=NA, age= NA) {
  result = ""
  if (!is.na(cancer)) result <- paste(result, "CANCER_TYPE == '", cancer, "'", sep = "")
  if (!is.na(cancer_subtype)) result <- paste(result, ", CANCER_TYPE_DETAILED == '", cancer_subtype, "'", sep = "")
  if (!is.na(sex)) result <- paste(result, ", SEX == '", sex, "'", sep = "")  
  if (!is.na(race)) result <- paste(result, ", PRIMARY_RACE == '", race, "'", sep = "")
  if (!is.na(age)) result <- paste(result, ", AGE_AT_SEQ_REPORT >= ", age[1], sep = "")
  if (!is.na(age)) result <- paste(result, ", AGE_AT_SEQ_REPORT < ", age[2], sep = "")
  result
}

```
