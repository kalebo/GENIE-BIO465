---
title: "PipelineDevelopment"
author: "Kaleb Olson"
date: "April 13, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggbiplot)
library(dplyr)
library(reshape2)
library(magrittr)
library(readr)
library(synapseClient)
library(doParallel)
synapseLogin()
```

Load all the data we want to work with.
```{r}
genie.filtered.cn <- readRDS("genie-filtered-cn.rds")
gdsc.filtered.cn <- readRDS("gdsc-filtered-cn.rds")
gdsc.filtered.cn.t <- readRDS("gdsc-filtered-cn-t.rds")

celline.to.cosmicid <- readRDS("gdsc-cellline-to-cosmic-id.rds")
screeened.compounds <- readRDS("screened-compounds.rds")
dose.response <- readRDS("dose-response.rds")

genie.clin <- readRDS("genie-clin.rds")
intersecting.genes <- readRDS("intersecting-genes.rds")
genie.filtered.cnclin <- readRDS("genie-filtered-cn-clin.rds")
```

Make a tree map breakdown of cancer and cancer sub-type.
```{r}
test.count <- genie.clin %>% group_by(CANCER_TYPE_DETAILED) %>% mutate(COUNT = n())
png(filename="tree.png",width=1024, height=600);
treemap(test.count, index=c("CANCER_TYPE", "CANCER_TYPE_DETAILED"), vSize = "COUNT", type="index", palette= "Reds", align.labels = list(c("center", "center"), c("right", "bottom")), title="GENIE - Breakdown by cancer and cancer sub-type", fontsize.labels=c(18,10), fontsize.title = 18);
dev.off()
```

Example of how genie.filtered.cnclin is generated:
```
syn.clin <- synGet('syn7851246')
genie.clin <- read_tsv(syn.clin@filePath)
genie.filtered.cn.cst <- melt(genie.filtered.cn) %>% dcast(variable ~ ...)
colnames(genie.filtered.cn.cst)[1] <- "SAMPLE_ID"
genie.filtered.cnclin <- inner_join(genie.clin, genie.filtered.cn.cst)
saveRDS(genie.filtered.cnclin, "genie-filtered-cn-clin.rds")
```

Here is how the transposed and trimed version of gdsc.filtered.cn was generated
```{r}
gdsc.filtered.cn.t <- as.data.frame(t(gdsc.filtered.cn))[c(-2, -3, -4),]

```

```{r}
translate <- function(quaddle) {
  maxchar <- substr(quaddle, 1, 1)
  max <- as.numeric(maxchar)
  if (!is.na(max) && max >= 9) {
    2
  }
  else if (!is.na(max) && max < 9) {
    switch(maxchar,
           "0" = -2,
           "1" = -1,
           "2" = 0,
           "3" = 1,
           "4" = 2,
           "5" = 2,
           "6" = 2,
           "7" = 2,
           "8" = 2)
  }
  else{
    NA
  }
}

gdsc.filtered.cn.trans <- apply(gdsc.filtered.cn.t, c(1,2), translate)
```

Here we check the gene EFGR (row number 138 in each dataset because we ordered genes alphabetically) to check that we get a comparable distribution of cnv values. This depends on an accurate translation of cnv data from gdsc style to genie style. The EFGR gene can be considered as a baseline because ...
```{r}
gdsc.efgr <- table(sapply( gdsc.filtered.cn[138, 5:ncol(gdsc.filtered.cn)],  translate))
genie.efgr <- table(unlist(genie.filtered.cn[138, 2:ncol(genie.filtered.cn) ]))
sapply(gdsc.efgr, function(x) x/ncol(gdsc.filtered.cn))
sapply(genie.efgr, function(x) x/ncol(genie.filtered.cn))

```
ERBB2
```{r}
gdsc.efgr <- table(sapply( gdsc.filtered.cn[150, 5:ncol(gdsc.filtered.cn)],  translate))
genie.efgr <- table(unlist(genie.filtered.cn[150, 2:ncol(genie.filtered.cn) ]))
sapply(gdsc.efgr, function(x) x/ncol(gdsc.filtered.cn))
sapply(genie.efgr, function(x) x/ncol(genie.filtered.cn))

```

Question: how many times does max not equal min in the unconverted GDSC data?
```{r}
maxeqmin <- function(x) {
  max_r <- substr(x, 1,1)
  min_r <- substr(x, 3,3)
  max_r == min_r
}


tout <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t),], c(1,2), maxeqmin)
table(tout)

```
Question: how many times do we find that if the two don't match that the max is greater than 8
```{r}
maxneandgt8 <- function(x) {
  quad <- unlist(strsplit(x, ","))
  max_r <- quad[1]
  min_r <- quad[2]
  max_i = as.numeric(max_r)
  
  if (max_i != min_r){
     max_i >= 4
  }
  else {
    FALSE
  }
}

mout <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t), ], c(1,2), maxneandgt8)
table(mout)
```

```{r}
bettertrans <- function(x){ 
  quad <- unlist(strsplit(x, ","))
  max_i <- as.numeric(quad[1])
  min_i <- as.numeric(quad[2])
  
  if (max_i == 0){
    -2
  }
  else if (max_i == 1) {
    -1
  }
  else if (max_i <= 3) {
    0
  }
  else if (max_i <= 8 && min_i < 8 ) {
    1
  }
  else {
    2
  }
}

gdsc.filtered.cn.bettertrans <- apply(gdsc.filtered.cn.t[2:nrow(gdsc.filtered.cn.t), ], c(1,2), bettertrans)
gdsc.cn.table <- as.data.frame(table(gdsc.filtered.cn.bettertrans))
colnames(gdsc.cn.table) <- c("cn", "freq")
```

```{r}
wipenonextr <- function(x){
  if (x != -2 || x != 2) {
    0
  }
  else {
    x
  }
}

sum(genie.filtered.cn[,2:ncol(genie.filtered.cn)] == -2) +
sum(genie.filtered.cn[,2:ncol(genie.filtered.cn)] == 2)
```

Make a plot of the distribution:
```{r}
genie.cn.table <- as.data.frame(table(unlist(genie.filtered.cn[,2:ncol(genie.filtered.cn)])))
colnames(genie.cn.table) <- c("cn", "freq")
```

```{r}
library(scales)
ggplot(genie.cn.table[-2,]) + geom_col(aes(x = cn, y = freq), fill="#B22222") + scale_y_log10( breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) + labs(x="Discrete CN Level", y ="Count", title="GENIE Copy Number Distribution")

ggplot(gdsc.cn.table) + geom_col(aes(x = cn, y = freq), fill="#B22222") + scale_y_log10( breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) + labs(x="Discrete CN Level", y ="Count", title="Translated GDSC Copy Number Distribution")
```


Now we choose a drug that is has at least one record that is very low IC50. In this case #104. We filter for this drug and any record that is less than our threshold of -2 for IC50
```{r}
gdsc.filtered.cn.bettertrans.df <- as.data.frame(gdsc.filtered.cn.bettertrans)
colnames(gdsc.filtered.cn.bettertrans.df) <- unlist(intersecting.genes)

library(data.table)
gdsc.filtered.cn.bettertrans.df <- setDT(gdsc.filtered.cn.bettertrans.df, keep.rownames = TRUE)[]
colnames(gdsc.filtered.cn.bettertrans.df)[1] <- "COSMIC_ID"

```

Now we show a trivial example of how we are going to compare profile sets. Note that we will need to consider the positive 2 and the negative 2 cases individually.
```{r}
drug_id = 104
drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < -2)
profilein.2 <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)

drug_id = 201
drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < -2)
profilein.1 <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)

profile.104 <- apply(unlist(profilein.1 == 2), 2, function(x) sum(x)/length(x))

profile.201 <-  apply(unlist(profilein.2 == 2), 2, function(x) sum(x)/length(x))
dist(rbind(profile.201, profile.104), method = "euclidian")
```

We we generalize the above as functions:
```{r}
subsetDist <- function(set_a, set_b, cnlevel) {
  colProp <- function(col) {sum(col)/length(col)}
  mkProfile <- function(set, cnlevel) {apply(unlist(set == cnlevel), 2, colProp)}
  profileDist <- function(p1, p2) {dist(rbind(p1, p2), method = "euclidian")}
  
  profileDist(mkProfile(set_a, cnlevel), mkProfile(set_b, 2))
}

compareDrugs <- function(drug_id1, drug_id2, threshold, cnlevel) {
  mkRecordSet <- function(drug_id, threshold) {
    drug.experiments <- filter(dose.response, DRUG_ID == drug_id, LN_IC50 < threshold)
    records <- filter(gdsc.filtered.cn.bettertrans.df, COSMIC_ID %in% drug.experiments$COSMIC_ID)
    assertthat::assert_that(length(records) >= 100)
    records
  }
  
  subsetDist(mkRecordSet(drug_id1, threshold), mkRecordSet(drug_id2, threshold), cnlevel)
}

```


